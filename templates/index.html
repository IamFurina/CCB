<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCB 句子生成器</title>
    <link rel="stylesheet" href="https://unpkg.com/naive-ui">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }
        .result-container {
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div id="app">
        <n-config-provider>
            <n-space vertical class="container">
                <n-h1>CCB 句子生成器</n-h1>
                <n-alert type="warning" title="注意">
                    您输入的数据可能会用于训练，请勿输入隐私信息。<br>本系统的句子由 DeepSeek 生成。
                </n-alert>
                
                <n-input 
                    v-model:value="theme" 
                    placeholder="请输入主题" 
                    clearable
                />
                
                <n-space>
                    <n-input-number 
                        v-model:value="lengthMin" 
                        :min="1" 
                        :max="15" 
                        :step="1"
                        placeholder="句子长度下限"
                    />
                    <n-input-number 
                        v-model:value="temperature" 
                        :min="0" 
                        :max="2" 
                        :step="0.1"
                        placeholder="温度"
                    />
                </n-space>
                
                <n-button 
                    type="primary" 
                    @click="startTask" 
                    :disabled="loading"
                    :loading="loading"
                    size="large"
                    round
                    style="margin-top: 16px"
                >
                    <template #icon>
                        <n-icon>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 2a10 10 0 0 1 10 10a10 10 0 0 1-10 10A10 10 0 0 1 2 12A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8a8 8 0 0 0 8 8a8 8 0 0 0 8-8a8 8 0 0 0-8-8m-1 3h2v6h-2V7m0 8h2v2h-2v-2z"/>
                            </svg>
                        </n-icon>
                    </template>
                    生成句子
                </n-button>
                
                <n-alert v-if="loading" type="info">
                    生成需要几分钟，可以暂时退出页面...
                </n-alert>
                
                <div class="result-container">
                    <n-card v-for="(item, index) in history" :key="index" :bordered="false" hoverable>
                        <n-space vertical>
                            <n-text :type="item.valid ? 'success' : 'error'" strong>
                                {{ item.sentence }}
                            </n-text>
                            <n-text depth="3" style="font-size: 12px">
                                {{ new Date().toLocaleString() }}
                            </n-text>
                        </n-space>
                    </n-card>
                    
                    <n-text v-if="explanation" type="info">
                        💡 {{ explanation }}
                    </n-text>
                </div>
                
                <n-space>
                    <n-button text type="primary" tag="a" href="/history">
                        查看网友生成的句子
                    </n-button>
                    <n-button text type="primary" tag="a" href="/explorer">
                        浏览 CCB 词
                    </n-button>
                </n-space>
            </n-space>
        </n-config-provider>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/naive-ui"></script>
    <script>
        const { createApp, ref } = Vue;
        const { 
            NConfigProvider, 
            NSpace, 
            NH1, 
            NAlert, 
            NInput, 
            NInputNumber, 
            NButton, 
            NText, 
            NCard 
        } = naive;

        createApp({
            components: {
                NConfigProvider,
                NSpace,
                NH1,
                NAlert,
                NInput,
                NInputNumber,
                NButton,
                NText,
                NCard
            },
            setup() {
                const theme = ref('');
                const lengthMin = ref(3);
                const temperature = ref(1.5);
                const loading = ref(false);
                const history = ref([]);
                const explanation = ref('');
                
                async function startTask() {
                    loading.value = true;
                    history.value = [];
                    explanation.value = '';
                    
                    try {
                        const response = await fetch('/submit', {
                            method: 'POST',
                            body: JSON.stringify({ 
                                theme: theme.value, 
                                length_min: lengthMin.value, 
                                temperature: temperature.value 
                            }),
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        const data = await response.json();
                        if (data.task_id) {
                            localStorage.setItem('task_id', data.task_id);
                            checkTaskStatus(data.task_id);
                        } else {
                            explanation.value = data.error;
                            loading.value = false;
                        }
                    } catch (error) {
                        explanation.value = error.message;
                        loading.value = false;
                    }
                }
                
                async function checkTaskStatus(task_id) {
                    const interval = setInterval(async () => {
                        const statusRes = await fetch(`/status/${task_id}`);
                        const data = await statusRes.json();
                        
                        if (data.sentences) {
                            history.value = data.sentences.map(sentence => ({
                                sentence: (sentence.valid ? '✅' : '❌') + sentence.sentence,
                                valid: sentence.valid
                            }));
                        }
                        
                        if (data.explanation) {
                            explanation.value = data.explanation;
                            loading.value = false;
                        }
                        
                        if (data.error) {
                            explanation.value = data.error;
                            loading.value = false;
                        }
                        
                        if (
